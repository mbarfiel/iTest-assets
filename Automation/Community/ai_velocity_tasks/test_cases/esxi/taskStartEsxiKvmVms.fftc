<?xml version="1.0"?>
<testCase version="7.1.0.201804110601">
    <general>
        <owner>MBarfield</owner>
        <language>Python</language>
    </general>
    <execution>
        <parameters version="7.1.0.201804110601">
            <parameters escape="true">
                <parameters xmlns:pt="http://www.fnfr.com/schemas/parameterTree">
                    <vcenterCmdLineIp pt:description="Server IP to run esxi cmd line">10.140.70.193</vcenterCmdLineIp>
                    <vcenterCmdLineUser pt:description="Username used for login" pt:mask="true">q0VNiGrV2tPwammPrSnywg==</vcenterCmdLineUser>
                    <vcenterCmdLinePassword pt:description="Password" pt:mask="true">Z2Got7uB3Oqcpq6h28bIbQ==</vcenterCmdLinePassword>
                    <vcenterHostIp pt:description="IP adderess for vcenter">10.140.64.20</vcenterHostIp>
                    <vcenterUser pt:description="User login name" pt:mask="true">S5rJYjeMXx2yqCkv1gxHvIqzzx4tWTWPIQfCMBifULk=</vcenterUser>
                    <vcenterPassword pt:description="Vcenter password" pt:mask="true">AiRWju4XCF4EP8oSiJdNBA==</vcenterPassword>
                </parameters>
            </parameters>
        </parameters>
    </execution>
    <testbed>project://ai_velocity_tasks/topologies/Velocity/KVM_Workshop/KVM_Workshop.tbml</testbed>
    <procedures>
        <item name="main">
            <steps>
                <item guid="a3f5bee5-267d-48b7-9bdd-e824873460b7" action="comment">
                    <command>
                        <body>variables</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="41e47cb1-6203-402d-b00a-11405e134b3b" action="eval">
                    <command>
                        <body>baselineSnapshot = velocity(&apos;property&apos;, &apos;-name&apos;, &apos;KVM_Workshop&apos;, &apos;baselineSnapshot&apos;)</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="49ded818-562f-4fa6-b408-0dabeeba0472" action="eval">
                    <command>
                        <body>vmImageName = velocity(&apos;property&apos;, &apos;-name&apos;, &apos;KVM_Workshop&apos;, &apos;vmImageName&apos;)</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="e8bc7053-dfab-46c6-bf3e-73a000a1087a" action="eval">
                    <command>
                        <body>snapshotId = velocity(&apos;property&apos;, &apos;-name&apos;, &apos;KVM_Workshop&apos;, &apos;snapshotId&apos;)</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="d62cacf1-81c0-4319-8a69-17b714b8610d" action="comment">
                    <command>
                        <body>Open sessions</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="373cd479-5fdf-493a-be33-14de0b670e4d" action="open" session="KVM_Workshop">
                    <command>
                        <body>project://d_vsphere/session_profiles/d_vsphere.ffsp</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.OpenStepPropertyGroup">
                        <stepProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                        <sessionProperties type="com.fnfr.svt.adapter.automation.tools.common.documents.TransferableDocumentObject" transferableToolId="com.fnfr.itest.applications.vmware.vi.core.tool" transferableType="com.fnfr.itest.applications.vmware.vi.core.VMwareViSessionProperties" ipAddress="[param(&apos;vcenterHostIp&apos;)]" ipAddress.inherit="false" user="[param(&apos;vcenterUser&apos;)]" user.inherit="false" password.masked="true" password="4RvNHVItEysfgleel3eCnq4+V35AW7A4sVxWZBvE1y0=" password.inherit="false"/>
                        <sessionClass type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                        <sessionVersion type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    </applicationProperties>
                </item>
                <item guid="2d567b57-5918-4fb0-adc3-3298e7893125" action="getVMInfo" session="KVM_Workshop" normalOffset="93.012" estimatedStepExecutionTime="0.173">
                    <command>
                        <body>[vmImageName]</body>
                    </command>
                    <postProcessing>
                        <analysisRules>
                            <item>
                                <extractorInfo extractorType="query">
                                    <extractorProperties type="com.fnfr.svt.mapping.execution.extractors.QueryDataExtractorPropertyGroup">
                                        <query>(.//vmInfoTable/row/Value)[7]</query>
                                    </extractorProperties>
                                </extractorInfo>
                                <processorInfo ruleType="store">
                                    <ruleProperties type="com.fnfr.svt.execution.builtin.processors.StoreProcessorPropertyGroup">
                                        <storageLocation>vmPwrState</storageLocation>
                                    </ruleProperties>
                                </processorInfo>
                            </item>
                        </analysisRules>
                    </postProcessing>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                </item>
                <item guid="a20d00b0-5463-4835-a41f-2f4d58e62aa8" action="if">
                    <command>
                        <body>vmPwrState != &apos;Powered Off&apos;:</body>
                    </command>
                    <nestedSteps>
                        <item guid="59b6187b-5eff-4265-9cf7-626d7d73ba20" action="comment">
                            <command>
                                <body>Power off VM and reset to baseline</body>
                            </command>
                            <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                        </item>
                        <item guid="d21345a4-4d31-482e-9f24-91c64076bcb6" action="powerOffVM" session="KVM_Workshop" normalOffset="41.15" estimatedStepExecutionTime="2.101">
                            <command>
                                <body>[vmImageName]</body>
                            </command>
                            <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                        </item>
                        <item guid="7f8931c5-d4c7-429d-aafa-5d60efe1af68" action="getVMInfo" session="KVM_Workshop" normalOffset="11.37" estimatedStepExecutionTime="0.159">
                            <command>
                                <body>[vmImageName]</body>
                            </command>
                            <postProcessing>
                                <analysisRules>
                                    <item>
                                        <extractorInfo extractorType="query">
                                            <extractorProperties type="com.fnfr.svt.mapping.execution.extractors.QueryDataExtractorPropertyGroup">
                                                <query>(.//vmInfoTable/row/Value)[7]</query>
                                            </extractorProperties>
                                        </extractorInfo>
                                        <processorInfo ruleType="assert">
                                            <ruleProperties type="com.fnfr.svt.execution.builtin.processors.AssertionPropertyGroup">
                                                <expression>value == &quot;Powered Off&quot;</expression>
                                                <actionsWhenTrue>
                                                    <item actionId="DeclareExecutionIssue">
                                                        <actionProperties type="com.fnfr.svt.execution.builtin.actions.ExecutionIssuePropertyGroup" severity="OK">
                                                            <message>Verify that VM is Powered Off</message>
                                                        </actionProperties>
                                                    </item>
                                                    <item actionId="PassTestIfNotAlreadyFailed">
                                                        <actionProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                                                    </item>
                                                </actionsWhenTrue>
                                                <actionsWhenFalse>
                                                    <item actionId="DeclareExecutionIssue">
                                                        <actionProperties type="com.fnfr.svt.execution.builtin.actions.ExecutionIssuePropertyGroup" severity="Information">
                                                            <message>Verify that VM is powered off</message>
                                                        </actionProperties>
                                                    </item>
                                                    <item actionId="RepeatStep">
                                                        <actionProperties type="com.fnfr.svt.execution.builtin.actions.RepeatStepPropertyGroup" delayBetweenRepeats="5.0"/>
                                                    </item>
                                                </actionsWhenFalse>
                                            </ruleProperties>
                                        </processorInfo>
                                    </item>
                                </analysisRules>
                            </postProcessing>
                            <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                        </item>
                    </nestedSteps>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="99c3cd0f-b340-4126-94ad-c4ac06f1d2a2" action="else">
                    <nestedSteps>
                        <item guid="f91aefbb-a11e-4d4e-925a-ae4f122ed92e" action="comment">
                            <command>
                                <body>Insert steps here for when the expression evaluates to false</body>
                            </command>
                            <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                            <useFieldsInCommand>false</useFieldsInCommand>
                        </item>
                    </nestedSteps>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="a3fedf20-16db-46b6-bbbd-4af60f4090e6" action="comment">
                    <command>
                        <body>Verify Powered Off before moving forward</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                </item>
                <item guid="ff505fda-c1f3-43d8-805c-89889a3c894f" action="comment">
                    <command>
                        <body>Restore snapshot</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                </item>
                <item guid="b5fa2f52-2643-4e59-a40d-488c60979b80" action="open" session="esxi_cmdline">
                    <command>
                        <body>project://d_vsphere/session_profiles/ssh_vsphere_cmdlet.ffsp</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.OpenStepPropertyGroup">
                        <stepProperties type="com.fnfr.svt.editors.terminal.documents.StepDefaultProperties"/>
                        <sessionProperties type="com.fnfr.svt.applications.ssh.documents.SSHProperties">
                            <ipAddress inherit="false">[param(&apos;vcenterCmdLineIp&apos;)]</ipAddress>
                            <user inherit="false">[param(&apos;vcenterCmdLineUser&apos;)]</user>
                            <password inherit="false">4RvNHVItEyuJ4ONH1jrcaDntJFzB5981wXgj7YUWL6xIHNAaGBit5A==</password>
                        </sessionProperties>
                        <sessionClass type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                        <sessionVersion type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                    </applicationProperties>
                </item>
                <item guid="21454af7-e90e-48b3-9714-d360d1eb4004" action="connectVcenterPwrSh" session="esxi_cmdline">
                    <command>
                        <body> -server [param(&apos;vcenterHostIp&apos;)] -user [param(&apos;vcenterUser&apos;)] -password [param(&apos;vcenterPassword&apos;)]</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.editors.terminal.documents.StepDefaultProperties"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="66e88910-9f0e-4008-82d0-2252d7c21015" action="restoreVmSnapshot" session="esxi_cmdline">
                    <command>
                        <body> -vmName [vmImageName] -snapshotName [baselineSnapshot]</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.editors.terminal.documents.StepDefaultProperties"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="8b39fe64-aecd-4060-bcd7-563228a65819" action="close" session="esxi_cmdline">
                    <applicationProperties type="com.fnfr.svt.editors.terminal.documents.StepDefaultProperties"/>
                    <useFieldsInCommand>false</useFieldsInCommand>
                </item>
                <item guid="138d43c4-f9e7-4ab0-a0f2-88094e8eb5f5" action="comment">
                    <command>
                        <body>Power on VM</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                </item>
                <item guid="d60de636-1395-4367-9450-272df716c53a" action="powerOnVM" session="KVM_Workshop">
                    <command>
                        <body>[vmImageName]</body>
                    </command>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                </item>
                <item guid="3a8cd6c4-4a64-4144-963b-230843d47066" action="getVMInfo" session="KVM_Workshop" normalOffset="97.209" estimatedStepExecutionTime="0.173">
                    <command>
                        <body>[vmImageName]</body>
                    </command>
                    <postProcessing>
                        <analysisRules>
                            <item>
                                <extractorInfo extractorType="query">
                                    <extractorProperties type="com.fnfr.svt.mapping.execution.extractors.QueryDataExtractorPropertyGroup">
                                        <query>(.//vmInfoTable/row/Value)[7]</query>
                                    </extractorProperties>
                                </extractorInfo>
                                <processorInfo ruleType="assert">
                                    <ruleProperties type="com.fnfr.svt.execution.builtin.processors.AssertionPropertyGroup">
                                        <expression>value == &quot;Powered On&quot;</expression>
                                        <actionsWhenTrue>
                                            <item actionId="DeclareExecutionIssue">
                                                <actionProperties type="com.fnfr.svt.execution.builtin.actions.ExecutionIssuePropertyGroup" severity="OK">
                                                    <message>{auto_message_true}</message>
                                                </actionProperties>
                                            </item>
                                            <item actionId="PassTestIfNotAlreadyFailed">
                                                <actionProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                                            </item>
                                        </actionsWhenTrue>
                                        <actionsWhenFalse>
                                            <item actionId="DeclareExecutionIssue">
                                                <actionProperties type="com.fnfr.svt.execution.builtin.actions.ExecutionIssuePropertyGroup" severity="Information">
                                                    <message>Keeping checking power state</message>
                                                </actionProperties>
                                            </item>
                                            <item actionId="RepeatStep">
                                                <actionProperties type="com.fnfr.svt.execution.builtin.actions.RepeatStepPropertyGroup" delayBetweenRepeats="5.0"/>
                                            </item>
                                        </actionsWhenFalse>
                                    </ruleProperties>
                                </processorInfo>
                            </item>
                        </analysisRules>
                    </postProcessing>
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                </item>
                <item guid="7a55b8ca-0881-4a04-a9bd-c1540f15f2ec" action="close" session="KVM_Workshop" normalOffset="70.882">
                    <applicationProperties type="com.fnfr.svt.documents.EmptyPropertyGroup"/>
                </item>
            </steps>
        </item>
    </procedures>
</testCase>
